--// Сервисы
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

--// Переменные
local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local mouse = player:GetMouse()
local targetRadius = 150
local enabled = false
local smoothness = 0.25 -- чем выше, тем сильнее "помощь" (0.25–0.3 оптимально)

--// Прицел
local aimCircle = Drawing.new("Circle")
aimCircle.Visible = false
aimCircle.Thickness = 2
aimCircle.Color = Color3.fromRGB(255, 0, 0)
aimCircle.Filled = false
aimCircle.Radius = targetRadius
aimCircle.Position = camera.ViewportSize / 2

--// UI кнопка
local gui = Instance.new("ScreenGui", game:GetService("CoreGui"))
local button = Instance.new("TextButton", gui)
button.Size = UDim2.new(0, 160, 0, 30)
button.Position = UDim2.new(0.5, -80, 0.9, 0)
button.Text = "Aimbot V1 BY HAI_BROYS: OFF"
button.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
button.TextColor3 = Color3.new(1, 1, 1)
button.Font = Enum.Font.GothamBold
button.TextSize = 14

button.MouseButton1Click:Connect(function()
    enabled = not enabled
    button.Text = enabled and "Aimbot V1 BY HAI_BROYS: ON" or "Aimbot V1 BY HAI_BROYS: OFF"
    button.BackgroundColor3 = enabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(100, 100, 100)
    aimCircle.Visible = enabled
end)

--// Фильтр целей
local function isValidTarget(character)
    if not character then return false end
    local humanoid = character:FindFirstChild("Humanoid")
    local head = character:FindFirstChild("Head")
    if not humanoid or not head or humanoid.Health <= 0 then return false end
    local plr = Players:GetPlayerFromCharacter(character)
    return plr ~= player
end

--// Проверка прямой видимости
local function isVisible(targetPart)
    local origin = camera.CFrame.Position
    local direction = (targetPart.Position - origin).Unit * (targetPart.Position - origin).Magnitude
    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {player.Character} -- игнорируем себя
    params.FilterType = Enum.RaycastFilterType.Blacklist

    local result = Workspace:Raycast(origin, direction, params)
    if result then
        return result.Instance:IsDescendantOf(targetPart.Parent) -- видно только если луч попал в самого врага
    end
    return false
end

--// Поиск ближайшей цели (в круге и в зоне видимости)
local function getClosestTarget()
    local closest = nil
    local shortestDistance = targetRadius
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player and p.Character and isValidTarget(p.Character) then
            local head = p.Character:FindFirstChild("Head")
            if head then
                local screenPos, onScreen = camera:WorldToViewportPoint(head.Position)
                if onScreen then
                    local distance = (Vector2.new(screenPos.X, screenPos.Y) - (camera.ViewportSize / 2)).Magnitude
                    if distance < shortestDistance and isVisible(head) then
                        shortestDistance = distance
                        closest = head
                    end
                end
            end
        end
    end
    return closest
end

--// Обновление камеры (плавное наведение)
RunService.RenderStepped:Connect(function()
    aimCircle.Position = camera.ViewportSize / 2
    aimCircle.Radius = targetRadius * (camera.ViewportSize.Y / 720)
    
    if enabled then
        local target = getClosestTarget()
        if target then
            local targetCF = CFrame.new(camera.CFrame.Position, target.Position)
            camera.CFrame = camera.CFrame:Lerp(targetCF, smoothness) -- плавное приближение к цели
        end
    end
end)

--// Обработка новых игроков (без задержки)
Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function() end)
end)

for _, plr in ipairs(Players:GetPlayers()) do
    if plr ~= player then
        plr.CharacterAdded:Connect(function() end)
    end
end
